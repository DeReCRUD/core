trigger:
  - master

pool:
  vmImage: 'Ubuntu 16.04'

steps:
- task: NodeTool@0
  inputs:
    versionSpec: '8.x'
  displayName: 'Install Node.js'

- script: |
    yarn install
    yarn bootstrap
    yarn add -D -W codecov jest-junit
  displayName: 'Install Dependencies'

- script: yarn lint
  displayName: 'Lint Source'

- script: yarn build
  displayName: 'Run Build'

- script: |
    yarn cover --ci --reporters=default --reporters=jest-junit --coverageReporters=lcov --coverageReporters=cobertura
    ./node_modules/.bin/codecov
  displayName: 'Run Tests and Coverage'

- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '**/junit.xml'
  displayName: 'Publish Test Results'

- task: PublishCodeCoverageResults@1
  inputs:
    codeCoverageTool: 'Cobertura'
    summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage/cobertura-coverage.xml'
    reportDirectory: '$(System.DefaultWorkingDirectory)/coverage/lcov-report'
  displayName: 'Publish Code Coverage Results'

- script: |
    cp -R dist/ $(Build.ArtifactStagingDirectory)
  displayName: 'Copy Artifacts'

- task: PublishBuildArtifacts@1
  inputs:
    pathtoPublish: '$(Build.ArtifactStagingDirectory)' 
    artifactName: 'package' 
    publishLocation: 'Container'
  displayName: 'Publish Artifacts'


